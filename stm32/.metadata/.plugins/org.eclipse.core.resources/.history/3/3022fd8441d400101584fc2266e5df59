/*
 * main.c
 *
 * Created on: 8th Dec 2025
 * Author: Rahul B.
 *
 * Description: RTC Calendar demonstration with user button press interrupt.
 */

/* Includes ------------------------------------------------------------------*/
#include <string.h>
#include <stdio.h>
#include <stdint.h>
#include <stdarg.h>
#include "stm32f4xx_hal.h"
#include "main.h" // Assuming this defines SYS_CLOCK_FREQ_50_MHZ, etc.

/* Private function prototypes -----------------------------------------------*/
void GPIO_Init(void);
void Error_Handler(void);
void UART2_Init(void);
void SystemClock_Config_HSE(uint8_t clock_freq);
void RTC_Init(void);
void RTC_CalendarConfig(void);

/* Private variables ---------------------------------------------------------*/
UART_HandleTypeDef huart2;
RTC_HandleTypeDef hrtc;

// Global flag to track if the time has been set for the first time
uint8_t IsTimeSet = 0;

/**
  * @brief  Print a string to console over UART.
  * @param  format: Format string as in printf.
  * @param  ...: Additional arguments providing the data to print.
  * @retval None
  */
void printmsg(char *format,...)
{
  char str[80];

  /*Extract the the argument list using VA apis */
  va_list args;
  va_start(args, format);
  vsprintf(str, format,args);
  HAL_UART_Transmit(&huart2,(uint8_t *)str, strlen(str),HAL_MAX_DELAY);
  va_end(args);
}

int main(void)
{
  HAL_Init();
  GPIO_Init();
  // Using 50 MHz for simplicity
  SystemClock_Config_HSE(50); // Assuming 50 corresponds to SYS_CLOCK_FREQ_50_MHZ
  UART2_Init();
  RTC_Init();

  printmsg("This is RTC calendar Test program\r\n");
  printmsg("Press User Button (PC13) to read the time.\r\n");

  // Check the RTC Backup Domain Register (BKP) to see if time was set previously.
  // We use a backup register (e.g., RTC_BKP_DR0) as a flag.
  if (HAL_RTCEx_BKUPRead(&hrtc, RTC_BKP_DR0) != 0x32F2)
  {
    // Time has not been set yet (first power-up or battery died)
    printmsg("Setting Initial RTC Time and Date...\r\n");
    RTC_CalendarConfig();

    // Set a flag in the backup register to indicate the time is set
    HAL_PWR_EnableBkUpAccess();
    HAL_RTCEx_BKUPWrite(&hrtc, RTC_BKP_DR0, 0x32F2);
    HAL_PWR_DisableBkUpAccess();

    // Print the time immediately after setting it
    HAL_GPIO_EXTI_Callback(0);
  }
  else
  {
    // Time was already set and is running (subsequent power-up)
    printmsg("RTC time already set. Reading current time...\r\n");
    HAL_GPIO_EXTI_Callback(0);
  }

  // --- Main execution loop ---
  // The MCU stays awake here. When the button is pressed (PC13), the EXTI
  // interrupt will fire, and HAL_GPIO_EXTI_Callback will print the time.
  while(1)
  {
      // Optional: Flash the LED to show the MCU is running
      HAL_GPIO_TogglePin(GPIOA, GPIO_PIN_5);
      HAL_Delay(1000); // 1 second delay
  }

  return 0;
}

// ... (SystemClock_Config_HSE remains the same)

/**
  * @brief RTC Initialization Function
  * @param None
  * @retval None
  */
void RTC_Init(void)
{
  // 1. Enable PWR Clock and Backup Access BEFORE calling HAL_RTC_Init
  __HAL_RCC_PWR_CLK_ENABLE();
  HAL_PWR_EnableBkUpAccess();

  // The rest of the RTC configuration
  hrtc.Instance = RTC;
  hrtc.Init.HourFormat =RTC_HOURFORMAT_12;
  hrtc.Init.AsynchPrediv = 0x7F;
  hrtc.Init.SynchPrediv = 0xFF;
  hrtc.Init.OutPut = RTC_OUTPUT_DISABLE;
  hrtc.Init.OutPutPolarity = RTC_OUTPUT_POLARITY_LOW;
  hrtc.Init.OutPutType = RTC_OUTPUT_TYPE_OPENDRAIN;

  if( HAL_RTC_Init(&hrtc) != HAL_OK)
  {
    Error_Handler();
  }
}

/**
  * @brief RTC calender configuration
  * @param None
  * @retval None
  */
void RTC_CalendarConfig(void)
{
  RTC_TimeTypeDef RTC_TimeInit;
  RTC_DateTypeDef RTC_DateInit;

  // Enable write access to the Backup domain for configuration
  __HAL_RCC_PWR_CLK_ENABLE();
  HAL_PWR_EnableBkUpAccess();


  // Configure the calendar for Time: 07:21:10 PM Date: 8 Dec 2025 MONDAY
  // Time Configuration - 07:21:10 PM
  RTC_TimeInit.Hours = 7;
  RTC_TimeInit.Minutes = 21;
  RTC_TimeInit.Seconds = 10;
  RTC_TimeInit.TimeFormat = RTC_HOURFORMAT12_PM;
  if (HAL_RTC_SetTime(&hrtc, &RTC_TimeInit, RTC_FORMAT_BIN) != HAL_OK)
  {
      Error_Handler();
  }

  // Date Configuration - 8 December 2025 , Monday
  RTC_DateInit.Date = 8;
  RTC_DateInit.Month = RTC_MONTH_DECEMBER;
  RTC_DateInit.Year = 25;  // Last 2 digits of year (2025)
  RTC_DateInit.WeekDay = RTC_WEEKDAY_MONDAY;

  if (HAL_RTC_SetDate(&hrtc, &RTC_DateInit, RTC_FORMAT_BIN) != HAL_OK)
  {
      Error_Handler();
  }
}

// ... (GPIO_Init and UART2_Init remain the same)

/**
  * @brief  Returns the name of the day of the week.
  * @param  number: The day of the week as a number (1 for Monday, 2 for Tuesday, etc.).
  * @retval char*: The name of the corresponding day of the week.
  */
char* getDayofweek(uint8_t number)
{
  char *weekday[] = { "Monday", "TuesDay", "Wednesday","Thursday","Friday","Saturday","Sunday"};

  // WeekDay value is 1 for Monday, up to 7 for Sunday.
  if (number >= 1 && number <= 7)
    return weekday[number-1];
  else
    return "Unknown";
}

/**
  * @brief  EXTI line detection callbacks.
  * @param  GPIO_Pin Specifies the pins connected EXTI line
  * @retval None
  */
void HAL_GPIO_EXTI_Callback(uint16_t GPIO_Pin)
{
  RTC_TimeTypeDef RTC_TimeRead;
  RTC_DateTypeDef RTC_DateRead;

  // The clock must be running for these reads to succeed
  // If we are in the EXTI callback from the button press (GPIO_Pin == GPIO_PIN_13):
  if (GPIO_Pin == GPIO_PIN_13)
  {
      printmsg("--- Button Press Detected ---\r\n");
      // Debounce logic (optional but recommended for buttons)
      HAL_Delay(50);
  }

  // Reading time and date
  HAL_RTC_GetTime(&hrtc,&RTC_TimeRead,RTC_FORMAT_BIN);
  HAL_RTC_GetDate(&hrtc,&RTC_DateRead,RTC_FORMAT_BIN);

  // Printing the time with PM/AM format for clarity (since we used 12-hour format)
  const char* ampm = (RTC_TimeRead.TimeFormat == RTC_HOURFORMAT12_PM) ? "PM" : "AM";

  printmsg("Current Time is : %02d:%02d:%02d %s\r\n", RTC_TimeRead.Hours, \
     RTC_TimeRead.Minutes, RTC_TimeRead.Seconds, ampm);

  printmsg("Current Date is : %02d-%02d-%02d  <%s> \r\n", RTC_DateRead.Month, RTC_DateRead.Date,\
     RTC_DateRead.Year, getDayofweek(RTC_DateRead.WeekDay));

  // Optional: Toggle the LED to visually confirm the interrupt fired
  HAL_GPIO_TogglePin(GPIOA, GPIO_PIN_5);
}

/**
  * @brief  This function is executed in case of error occurrence.
  * @retval None
  */
void Error_Handler(void)
{
  while(1);
}
